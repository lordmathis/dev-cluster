container_runtime: containerd

# LAPI (Local API) Configuration
lapi:
  envFrom:
    - secretRef:
        name: crowdsec-enrollment

  # Persistent volumes for LAPI
  persistentVolume:
    data:
      enabled: true
      size: 1Gi
      storageClassName: "retain-local-path"
    config:
      enabled: true
      size: 100Mi
      storageClassName: "retain-local-path"

  resources:
    limits:
      memory: 250Mi
      cpu: 250m
    requests:
      cpu: 100m
      memory: 250Mi

# Agent Configuration
agent:
  # Acquire Traefik logs from pods
  acquisition:
    - namespace: traefik
      podName: traefik-*
      program: traefik

  # Install collections for Traefik protection
  env:
    - name: COLLECTIONS
      value: "crowdsecurity/traefik crowdsecurity/http-cve crowdsecurity/whitelist-good-actors"

  resources:
    limits:
      memory: 250Mi
      cpu: 250m
    requests:
      cpu: 100m
      memory: 250Mi

# Main configuration file (handles auto-registration)
config:
  config.yaml.local: |
    api:
      server:
        auto_registration:
          enabled: true
          token: "$${REGISTRATION_TOKEN}"  # Auto-generated by the chart
          allowed_ranges:
            - "127.0.0.1/32"
            - "10.0.0.0/8"
            - "172.16.0.0/12"
            - "192.168.0.0/16"

  postoverflows:
    s01-whitelist:
      mywhitelist.yaml: |
        name: custom/mywhitelist
        description: "Custom IP whitelist"
        filter: "1 == 1"
        whitelist:
          reason: "Trusted IPs"
          ip:
            - "${CROWDSEC_WHITELIST_IP}"
